<%- include('../_partials/header') %>

<div class="dashboard-container">
    <%- include('../_partials/sidebar') %>

    <!-- Contenido Principal -->
    <main id="main-content">
        <%- include('../_partials/sub_header') %>
        <%- include('../_partials/notificaciones') %>

        <section id="usuarios">
            <h2 class="section-title">Listado de Usuarios</h2>

            <!-- Barra de búsqueda -->
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" placeholder="Buscar por nombre">
            </div>

            <!-- Botones para agregar Paciente y Trabajador -->
            <button id="btnAgregarPaciente" class="add-button">
                <i class="fas fa-plus-circle"></i> Agregar Paciente
            </button>
            <button id="btnAgregarTrabajador" class="add-button">
                <i class="fas fa-plus-circle"></i> Agregar Trabajador
            </button>

            <!-- Tabla de Usuarios -->
            <table id="usuarios-table" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead style="background-color: #007BFF; color: white;">
                    <tr>
                        <th style="padding: 10px; text-align: left;">DNI</th>
                        <th style="padding: 10px; text-align: left;">Nombre</th>
                        <th style="padding: 10px; text-align: left;">Apellido</th>
                        <th style="padding: 10px; text-align: left;">Email</th>
                        <th style="padding: 10px; text-align: left;">Rol</th>
                        <th style="padding: 10px; text-align: left;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <% usuarios.forEach(usuario => { %>
                        <tr>
                            <td style="padding: 10px;"><%= usuario.dni %></td>
                            <td style="padding: 10px;"><%= usuario.nombre || 'N/A' %></td>
                            <td style="padding: 10px;"><%= usuario.apellido || 'N/A' %></td>
                            <td style="padding: 10px;"><%= usuario.email || 'N/A' %></td>
                            <td style="padding: 10px;">
                                <% if (usuario.rol_id === 1) { %>
                                    Paciente
                                <% } else if (usuario.rol_id === 2) { %>
                                    Medico
                                <% } else if (usuario.rol_id === 3) { %>
                                    Administrador
                                <% } else { %>
                                    Desconocido
                                <% } %>
                            </td>
                            <td style="padding: 10px;">
                                <button 
                                    onclick="editarUsuario('<%= usuario.dni %>')" 
                                    style="background-color: #28a745; color: white; border: none; padding: 10px 10px; cursor: pointer; margin-right: 5px;" 
                                    class="edit-button">
                                    Editar
                                </button>
                                <button 
                                    onclick="eliminarUsuario('<%= usuario.dni %>')" 
                                    style="background-color: #dc3545; color: white; border: none; padding: 10px 10px; cursor: pointer;" 
                                    class="delete-button">
                                    Eliminar
                                </button>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </section>
    </main>
</div>

<!-- Modal para añadir -->
<div id="modalUsuario" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalTitle">Agregar Usuario</h2>
        <form id="formUsuario">
            <div class="form-group">
                <label for="dniUsuario">DNI</label>
                <input type="text" id="dniUsuario" name="dniUsuario" required>
            </div>
            <div class="form-group">
                <label for="nombreUsuario">Nombre</label>
                <input type="text" id="nombreUsuario" name="nombreUsuario" required>
            </div>
            <div class="form-group">
                <label for="apellidoUsuario">Apellido</label>
                <input type="text" id="apellidoUsuario" name="apellidoUsuario" required>
            </div>
            <div class="form-group">
                <label for="emailUsuario">Email</label>
                <input type="email" id="emailUsuario" name="emailUsuario" required>
            </div>
            <div class="form-group">
                <label for="rol">Rol</label>
                <select id="rol" name="rol" required></select>
            </div>
            <div class="form-group">
                <label for="contraseñaUsuario">Contraseña</label>
                <input type="password" id="contraseñaUsuario" name="contraseñaUsuario" required>
            </div>
            <div class="form-group">
                <label for="repetirContraseñaUsuario">Repetir Contraseña</label>
                <input type="password" id="repetirContraseñaUsuario" name="repetirContraseñaUsuario" required>
            </div>
            <button type="submit" class="btn-guardar">Guardar</button>
        </form>
    </div>
</div>

<!-- Modal para editar trabajador -->
<div id="modalTrabajador" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalTitleTrabajador">Editar Trabajador</h2>
        <form id="formTrabajador">
            <div class="form-group">
                <label for="dniTrabajador">DNI</label>
                <input type="text" id="dniTrabajador" name="dniTrabajador" required>
            </div>
            <div class="form-group">
                <label for="nombreTrabajador">Nombre</label>
                <input type="text" id="nombreTrabajador" name="nombreTrabajador" required>
            </div>
            <div class="form-group">
                <label for="apellidoTrabajador">Apellido</label>
                <input type="text" id="apellidoTrabajador" name="apellidoTrabajador" required>
            </div>
            <div class="form-group">
                <label for="emailTrabajador">Email</label>
                <input type="email" id="emailTrabajador" name="emailTrabajador" required>
            </div>
            <div class="form-group">
                <label for="especialidad">Especialidad</label>
                <input type="text" id="especialidad" name="especialidad" required>
            </div>
            <div class="form-group">
                <label for="telefonoTrabajador">Teléfono</label>
                <input type="text" id="telefonoTrabajador" name="telefonoTrabajador" required>
            </div>
            <div class="form-group">
                <label for="rol">Rol</label>
                <select id="rol" name="rol" required></select>
            </div>
            <div class="form-group">
                <label for="contraseñaUsuario">Contraseña</label>
                <input type="password" id="contraseñaUsuario" name="contraseñaUsuario" required>
            </div>
            <div class="form-group">
                <label for="repetirContraseñaUsuario">Repetir Contraseña</label>
                <input type="password" id="repetirContraseñaUsuario" name="repetirContraseñaUsuario" required>
            </div>
            <button type="submit" class="btn-guardar">Guardar</button>
        </form>
    </div>
</div>


<!-- Modal para editar paciente -->
<div id="modalPaciente" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalTitlePaciente">Editar Paciente</h2>
        <form id="formPaciente">
            <div class="form-group">
                <label for="dniPaciente">DNI</label>
                <input type="text" id="dniPaciente" name="dniPaciente" required>
            </div>
            <div class="form-group">
                <label for="nombrePaciente">Nombre</label>
                <input type="text" id="nombrePaciente" name="nombrePaciente" required>
            </div>
            <div class="form-group">
                <label for="apellidoPaciente">Apellido</label>
                <input type="text" id="apellidoPaciente" name="apellidoPaciente" required>
            </div>
            <div class="form-group">
                <label for="emailPaciente">Email</label>
                <input type="email" id="emailPaciente" name="emailPaciente" required>
            </div>
            <div class="form-group">
                <label for="fechaNacimiento">Fecha de Nacimiento</label>
                <input type="date" id="fechaNacimiento" name="fechaNacimiento" required>
            </div>
            <div class="form-group">
                <label for="genero">Género</label>
                <select id="genero" name="genero" required>
                    <option value="masculino">Masculino</option>
                    <option value="femenino">Femenino</option>
                </select>
            </div>
            <div class="form-group">
                <label for="estadoCivil">Estado Civil</label>
                <select id="estadoCivil" name="estadoCivil" required>
                    <option value="soltero">Soltero</option>
                    <option value="casado">Casado</option>
                    <option value="divorciado">Divorciado</option>
                    <option value="viudo">Viudo</option>
                </select>
            </div>
            <div class="form-group">
                <label for="ocupacion">Ocupación</label>
                <input type="text" id="ocupacion" name="ocupacion" required>
            </div>
            <div class="form-group">
                <label for="telefonoPaciente">Teléfono</label>
                <input type="text" id="telefonoPaciente" name="telefonoPaciente" required>
            </div>
            <div class="form-group">
                <label for="direccionPaciente">Dirección</label>
                <input type="text" id="direccionPaciente" name="direccionPaciente" required>
            </div>
            <div class="form-group">
                <label for="rol">Rol</label>
                <select id="rol" name="rol" required></select>
            </div>
            <div class="form-group">
                <label for="contraseñaUsuario">Contraseña</label>
                <input type="password" id="contraseñaUsuario" name="contraseñaUsuario" required>
            </div>
            <div class="form-group">
                <label for="repetirContraseñaUsuario">Repetir Contraseña</label>
                <input type="password" id="repetirContraseñaUsuario" name="repetirContraseñaUsuario" required>
            </div>
            <button type="submit" class="btn-guardar">Guardar</button>
        </form>
    </div>
</div>

    

<script>
    document.addEventListener("DOMContentLoaded", function () {
    // Referencias a elementos del DOM
    const btnAgregarPaciente = document.getElementById("btnAgregarPaciente");
    const btnAgregarTrabajador = document.getElementById("btnAgregarTrabajador");
    const modal = document.getElementById("modalUsuario");
    const modalTitle = document.getElementById("modalTitle");
    const formUsuario = document.getElementById("formUsuario");
    const rolSelect = document.getElementById("rol");
    const closeModal = document.querySelector(".close");
    const searchInput = document.getElementById("searchInput");
    const usuariosTableBody = document.querySelector("#usuarios-table tbody");

    // Función para actualizar la tabla de usuarios
    function actualizarTabla(usuarios) {
        usuariosTableBody.innerHTML = ''; // Limpiar tabla

        usuarios.forEach(usuario => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding: 10px;">${usuario.dni}</td>
                <td style="padding: 10px;">${usuario.nombre || 'N/A'}</td>
                <td style="padding: 10px;">${usuario.apellido || 'N/A'}</td>
                <td style="padding: 10px;">${usuario.email || 'N/A'}</td>
                <td style="padding: 10px;">
                    ${usuario.rol_id === 1 ? 'Paciente' : usuario.rol_id === 2 ? 'Medico' : usuario.rol_id === 3 ? 'Especialista' : 'Desconocido'}
                </td>
                <td style="padding: 10px;">
                    <button onclick="editarUsuario('${usuario.dni}')" class="edit-button" style="background-color: #28a745; color: white; padding: 10px;">Editar</button>
                    <button onclick="eliminarUsuario('${usuario.dni}')" class="delete-button" style="background-color: #dc3545; color: white; padding: 10px;">Eliminar</button>
                </td>
            `;
            usuariosTableBody.appendChild(tr);
        });
    }

    // Función para buscar usuarios en tiempo real
    searchInput.addEventListener('input', async (e) => {
        const dni = e.target.value;

        try {
            const response = await fetch(`/dashboard_jmedico/cuentas/buscar?dni=${dni}`);
            if (!response.ok) throw new Error('Error al buscar cuentas');

            const usuarios = await response.json();
            actualizarTabla(usuarios);
        } catch (error) {
            console.error('Error:', error);
        }
    });

    // Función para mostrar el modal para agregar un paciente
    btnAgregarPaciente.addEventListener("click", function () {
        modalTitle.textContent = "Agregar Paciente"; // Título del modal
        formUsuario.reset(); // Reiniciar formulario
        rolSelect.innerHTML = `<option value="1">Paciente</option>`; // Asignar opciones de rol
        modal.classList.add("show"); // Mostrar modal
    });

    // Función para mostrar el modal para agregar un trabajador
    btnAgregarTrabajador.addEventListener("click", function () {
        modalTitle.textContent = "Agregar Trabajador"; // Título del modal
        formUsuario.reset(); // Reiniciar formulario
        rolSelect.innerHTML = `
            <option value="2">Medico</option>
            <option value="3">Administrador</option>
        `; // Asignar opciones de rol
        modal.classList.add("show"); // Mostrar modal
    });

    // Función para cerrar el modal
    closeModal.addEventListener("click", function () {
        modal.classList.remove("show"); // Ocultar modal
    });

    // Cerrar el modal si se hace clic fuera del contenido
    window.addEventListener("click", function (event) {
        if (event.target === modal) {
            modal.classList.remove("show");
        }
    });

    // Función para guardar los datos del formulario
    formUsuario.addEventListener("submit", async (event) => {
        event.preventDefault();

        const dni = document.getElementById("dniUsuario").value;
        const nombre = document.getElementById("nombreUsuario").value;
        const apellido = document.getElementById("apellidoUsuario").value;
        const email = document.getElementById("emailUsuario").value;
        const rol = document.getElementById("rol").value;
        const contrasena = document.getElementById("contraseñaUsuario").value;
        const repetirContrasena = document.getElementById("repetirContraseñaUsuario").value;

        // Validar que las contraseñas coincidan
        if (contrasena !== repetirContrasena) {
            alert("Las contraseñas no coinciden.");
            return;
        }

        try {
            // Verificar si el DNI ya está registrado
            const response = await fetch(`/dashboard_jmedico/cuentas/validar-dni?dni=${dni}`);
            const { existe } = await response.json();

            if (existe) {
                alert("El DNI ya está registrado.");
                return;
            }

            // Enviar los datos al servidor
            const responseGuardar = await fetch('/dashboard_jmedico/cuentas/guardar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    dni,
                    nombre,
                    apellido,
                    email,
                    rol,
                    contrasena
                })
            });

            const result = await responseGuardar.json();

            if (result.success) {
                alert(result.mensaje);
                modal.classList.remove("show");
                cargarUsuarios();
            } else {
                alert(result.mensaje);
            }
        } catch (error) {
            console.error("Error al guardar usuario:", error);
            alert("Error al guardar usuario");
        }
    });

    // Llamada inicial para cargar usuarios al inicio
    async function cargarUsuarios() {
        try {
            const response = await fetch(`/dashboard_jmedico/cuentas/buscar`);
            const usuarios = await response.json();
            actualizarTabla(usuarios);
        } catch (error) {
            console.error("Error al cargar usuarios:", error);
        }
    }

    


    cargarUsuarios();
});

</script>



<%- include('../_partials/footer') %>
