<%- include('../_partials/header') %>
<div class="dashboard-container">
    <%- include('../_partials/sidebar') %>

    <!-- Contenido Principal -->
    <main id="main-content">
        <%- include('../_partials/sub_header') %>

        <!-- Lista de Notificaciones -->
        <%- include('../_partials/notificaciones') %>

        <!-- Sección de Historia Clínica -->
        <section id="historia">
            <h2 class="section-title">Listado de Historia Clínica</h2>

            <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <input type="text" id="buscar-dni" placeholder="DNI" style="padding: 10px; border: 1px solid #ced4da; border-radius: 4px; width: 150px; margin-right: 10px;"/>
                <input type="text" id="buscar-nombre" placeholder="Nombre" style="padding: 10px; border: 1px solid #ced4da; border-radius: 4px; width: 150px; margin-right: 10px;"/>
                <button id="buscar-btn" style="padding: 10px 15px; background-color: #007BFF; color: white; border: none; border-radius: 4px; cursor: pointer;">Buscar</button>
            </div>

            <!-- Formulario para agregar o editar historia clínica -->
            <div style="background-color: #e9ecef; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 id="form-title">Agregar Historia Clínica</h3>
                <input type="text" id="nuevo-dni" placeholder="DNI" style="padding: 10px; margin-right: 10px;"/>
                <input type="text" id="nuevo-nombre" placeholder="Nombre y Apellido" style="padding: 10px; margin-right: 10px;"/>
                <input type="date" id="nuevo-fecha-nacimiento" placeholder="Fecha de Nacimiento" style="padding: 10px; margin-right: 10px;"/>
                <input type="number" id="nuevo-edad" placeholder="Edad" style="padding: 10px; margin-right: 10px;" readonly/>
                <select id="nuevo-genero" style="padding: 10px; margin-right: 10px;">
                    <option value="Masculino">Masculino</option>
                    <option value="Femenino">Femenino</option>
                </select>
                <input type="text" id="nuevo-estado-civil" placeholder="Estado Civil" style="padding: 10px; margin-right: 10px;"/>
                <input type="text" id="nuevo-ocupacion" placeholder="Ocupación" style="padding: 10px; margin-right: 10px;"/>
                <input type="tel" id="nuevo-telefono" placeholder="Teléfono" style="padding: 10px; margin-right: 10px;"/>
                <input type="email" id="nuevo-correo" placeholder="Correo" style="padding: 10px; margin-right: 10px;"/>
                <button id="agregar-btn" style="padding: 10px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Guardar</button>
            </div>

            <!-- Tabla de Historias Clínicas -->
            <table id="historia-table" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead style="background-color: #007BFF; color: white;">
                    <tr>
                        <th style="padding: 10px; text-align: left;">DNI</th>
                        <th style="padding: 10px; text-align: left;">Nombre y Apellido</th>
                        <th style="padding: 10px; text-align: left;">Fecha de Nacimiento</th>
                        <th style="padding: 10px; text-align: left;">Edad</th>
                        <th style="padding: 10px; text-align: left;">Género</th>
                        <th style="padding: 10px; text-align: left;">Estado Civil</th>
                        <th style="padding: 10px; text-align: left;">Ocupación</th>
                        <th style="padding: 10px; text-align: left;">Teléfono</th>
                        <th style="padding: 10px; text-align: left;">Correo</th>
                        <th style="padding: 10px; text-align: left;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Las filas de historias se generarán dinámicamente con JavaScript -->
                </tbody>
            </table>
        </section>
    </main>
</div>

<script>
    let historias = [
        { id: 1, dni: "12345678", nombre: "Juan Pérez", fechaNacimiento: "1990-03-15", edad: 34, genero: "Masculino", estadoCivil: "Soltero", ocupacion: "Ingeniero", telefono: "987654321", correo: "juan.perez@mail.com" },
        { id: 2, dni: "87654321", nombre: "María García", fechaNacimiento: "1985-07-22", edad: 39, genero: "Femenino", estadoCivil: "Casada", ocupacion: "Doctora", telefono: "912345678", correo: "maria.garcia@mail.com" }
    ];

    let historiaSeleccionada = null;

    function renderTable(filtrar = false) {
        const tableBody = document.querySelector("#historia-table tbody");
        tableBody.innerHTML = ""; 

        let historiasFiltradas = historias;

        if (filtrar) {
            const dniBuscar = document.getElementById('buscar-dni').value;
            const nombreBuscar = document.getElementById('buscar-nombre').value;

            historiasFiltradas = historias.filter(historia => 
                (!dniBuscar || historia.dni.includes(dniBuscar)) &&
                (!nombreBuscar || historia.nombre.toLowerCase().includes(nombreBuscar.toLowerCase()))
            );
        }

        historiasFiltradas.forEach(historia => {
            const row = `
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 10px;">${historia.dni}</td>
                    <td style="padding: 10px;">${historia.nombre}</td>
                    <td style="padding: 10px;">${historia.fechaNacimiento}</td>
                    <td style="padding: 10px;">${historia.edad}</td>
                    <td style="padding: 10px;">${historia.genero}</td>
                    <td style="padding: 10px;">${historia.estadoCivil}</td>
                    <td style="padding: 10px;">${historia.ocupacion}</td>
                    <td style="padding: 10px;">${historia.telefono}</td>
                    <td style="padding: 10px;">${historia.correo}</td>
                    <td style="padding: 10px;">
                        <button onclick="editarHistoria(${historia.id})" style="background-color: #28a745; color: white; border: none; padding: 5px 10px; cursor: pointer; margin-right: 5px;">Editar</button>
                        <button onclick="verHistoria(${historia.id})" style="background-color: #007BFF; color: white; border: none; padding: 5px 10px; cursor: pointer; margin-right: 5px;">Ver</button>
                        <button onclick="eliminarHistoria(${historia.id})" style="background-color: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer;">Eliminar</button>
                    </td>
                </tr>
            `;
            tableBody.insertAdjacentHTML('beforeend', row);
        });
    }

    // Función para agregar o editar historia
    document.getElementById('agregar-btn').addEventListener('click', function() {
        const dni = document.getElementById('nuevo-dni').value;
        const nombre = document.getElementById('nuevo-nombre').value;
        const fechaNacimiento = document.getElementById('nuevo-fecha-nacimiento').value;
        const edad = calcularEdad(fechaNacimiento);
        const genero = document.getElementById('nuevo-genero').value;
        const estadoCivil = document.getElementById('nuevo-estado-civil').value;
        const ocupacion = document.getElementById('nuevo-ocupacion').value;
        const telefono = document.getElementById('nuevo-telefono').value;
        const correo = document.getElementById('nuevo-correo').value;

        if (historiaSeleccionada) {
            // Editar
            historiaSeleccionada.dni = dni;
            historiaSeleccionada.nombre = nombre;
            historiaSeleccionada.fechaNacimiento = fechaNacimiento;
            historiaSeleccionada.edad = edad;
            historiaSeleccionada.genero = genero;
            historiaSeleccionada.estadoCivil = estadoCivil;
            historiaSeleccionada.ocupacion = ocupacion;
            historiaSeleccionada.telefono = telefono;
            historiaSeleccionada.correo = correo;

            historiaSeleccionada = null; // Reiniciar la selección
            document.getElementById('form-title').textContent = "Agregar Historia Clínica";
        } else {
            // Agregar
            const nuevaHistoria = {
                id: historias.length > 0 ? historias[historias.length - 1].id + 1 : 1,
                dni,
                nombre,
                fechaNacimiento,
                edad,
                genero,
                estadoCivil,
                ocupacion,
                telefono,
                correo
            };
            historias.push(nuevaHistoria);
        }

        limpiarFormulario();
        renderTable();
    });

    // Función para calcular la edad a partir de la fecha de nacimiento
    function calcularEdad(fechaNacimiento) {
        const hoy = new Date();
        const fechaNac = new Date(fechaNacimiento);
        let edad = hoy.getFullYear() - fechaNac.getFullYear();
        const mes = hoy.getMonth() - fechaNac.getMonth();
        if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNac.getDate())) {
            edad--;
        }
        return edad;
    }

    // Función para limpiar el formulario
    function limpiarFormulario() {
        document.getElementById('nuevo-dni').value = '';
        document.getElementById('nuevo-nombre').value = '';
        document.getElementById('nuevo-fecha-nacimiento').value = '';
        document.getElementById('nuevo-edad').value = '';
        document.getElementById('nuevo-genero').value = 'Masculino';
        document.getElementById('nuevo-estado-civil').value = '';
        document.getElementById('nuevo-ocupacion').value = '';
        document.getElementById('nuevo-telefono').value = '';
        document.getElementById('nuevo-correo').value = '';
        document.getElementById('form-title').textContent = "Agregar Historia Clínica";
    }

    // Función para editar una historia
    function editarHistoria(id) {
        historiaSeleccionada = historias.find(historia => historia.id === id);
        document.getElementById('nuevo-dni').value = historiaSeleccionada.dni;
        document.getElementById('nuevo-nombre').value = historiaSeleccionada.nombre;
        document.getElementById('nuevo-fecha-nacimiento').value = historiaSeleccionada.fechaNacimiento;
        document.getElementById('nuevo-edad').value = historiaSeleccionada.edad;
        document.getElementById('nuevo-genero').value = historiaSeleccionada.genero;
        document.getElementById('nuevo-estado-civil').value = historiaSeleccionada.estadoCivil;
        document.getElementById('nuevo-ocupacion').value = historiaSeleccionada.ocupacion;
        document.getElementById('nuevo-telefono').value = historiaSeleccionada.telefono;
        document.getElementById('nuevo-correo').value = historiaSeleccionada.correo;

        document.getElementById('form-title').textContent = "Editar Historia Clínica";
    }

    // Función para ver una historia
    function verHistoria(id) {
        const historia = historias.find(historia => historia.id === id);
        alert(`DNI: ${historia.dni}\nNombre: ${historia.nombre}\nFecha de Nacimiento: ${historia.fechaNacimiento}\nEdad: ${historia.edad}\nGénero: ${historia.genero}\nEstado Civil: ${historia.estadoCivil}\nOcupación: ${historia.ocupacion}\nTeléfono: ${historia.telefono}\nCorreo: ${historia.correo}`);
    }

    // Función para eliminar una historia
    function eliminarHistoria(id) {
        if (confirm("¿Estás seguro de que deseas eliminar esta historia clínica?")) {
            historias = historias.filter(historia => historia.id !== id);
            renderTable();
        }
    }

    // Evento para buscar historias por DNI o nombre
    document.getElementById('buscar-btn').addEventListener('click', function() {
        renderTable(true);
    });

    // Calcular edad automáticamente cuando se cambia la fecha de nacimiento
    document.getElementById('nuevo-fecha-nacimiento').addEventListener('change', function() {
        const fechaNacimiento = this.value;
        const edad = calcularEdad(fechaNacimiento);
        document.getElementById('nuevo-edad').value = edad;
    });

    // Inicializar la tabla con los datos de prueba
    renderTable();
</script>
