<%- include('../_partials/header') %>

<div class="dashboard-container">
    <%- include('../_partials/sidebar') %>

    <!-- Contenido Principal -->
    <main id="main-content">
        <%- include('../_partials/sub_header') %>
        <!-- Lista de Notificaciones -->
        <%- include('../_partials/notificaciones') %>

        <div class="main-content">
            <h2 class="title">Gestión de Servicios</h2>

            <!-- Barra de Búsqueda -->
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" placeholder="Buscar servicios...">
            </div>
            <button id="btnAgregarServicio" class="add-button">
                <i class="fas fa-plus-circle"></i> Añadir Servicio
            </button>

            <!-- Tabla de Servicios -->
            <div class="table-container">
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead style="background-color: #007BFF; color: white;">
                        <tr>
                            <th style="padding: 10px; text-align: left;">Nombre</th>
                            <th style="padding: 10px; text-align: left;">Tipo</th>
                            <th style="padding: 10px; text-align: left;">Costo</th>
                            <th style="padding: 10px; text-align: left;">Tiempo Procedimiento</th>
                            <th style="padding: 10px; text-align: left;">Tiempo Recuperación</th>
                            <th style="padding: 10px; text-align: left;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaServicios">
                        <% servicios.forEach(servicio => { %>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px;"><%= servicio.nombre_servicio %></td>
                                <td style="padding: 10px;"><%= servicio.tipo_procedimiento %></td>
                                <td style="padding: 10px;"><%= servicio.costo %></td>
                                <td style="padding: 10px;"><%= servicio.tiempo_estimado %></td>
                                <td style="padding: 10px;"><%= servicio.tiempo_recuperacion %></td>
                                <td style="padding: 10px;">
                                    <button class="btn-editar" style="padding: 5px 10px; background-color: #ffc107; color: white; border: none; border-radius: 4px; cursor: pointer;">Editar</button>
                                    <button style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Eliminar</button>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<!-- Modal para añadir/editar servicio -->
<div id="modalServicio" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalTitle">Añadir Servicio</h2>
        <form id="formServicio">
            <div class="form-group">
                <label for="nombre">Nombre del Servicio</label>
                <input type="text" id="nombre" name="nombre" required>
            </div>
            <div class="form-group">
                <label for="tipoProcedimiento">Tipo de Procedimiento</label>
                <input type="text" id="tipoProcedimiento" name="tipoProcedimiento" required>
            </div>
            <div class="form-group">
                <label for="costo">Costo</label>
                <input type="number" id="costo" name="costo" required>
            </div>
            <div class="form-group">
                <label for="tiempoEstimadoProcedimiento">Tiempo Estimado de Procedimiento</label>
                <input type="text" id="tiempoEstimadoProcedimiento" name="tiempoEstimadoProcedimiento" required>
            </div>
            <div class="form-group">
                <label for="tiempoEstimadoRecuperacion">Tiempo Estimado de Recuperación</label>
                <input type="text" id="tiempoEstimadoRecuperacion" name="tiempoEstimadoRecuperacion" required>
            </div>
            <button type="button" id="btnGuardar" class="btn-guardar">Guardar</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById("searchInput");
        const tablaServicios = document.getElementById("tablaServicios");
        const btnAgregarServicio = document.getElementById("btnAgregarServicio");
        const modal = document.getElementById("modalServicio");
        const closeModal = document.querySelector(".close");
        const formServicio = document.getElementById("formServicio");
        const btnGuardar = document.getElementById("btnGuardar");
    
        // Funcionalidad de búsqueda en tiempo real
        searchInput.addEventListener("input", async function () {
            const nombre = searchInput.value.trim();
            
            try {
                const response = await fetch(`/dashboard_jmedico/servicios/buscar?nombre=${encodeURIComponent(nombre)}`);
                const servicios = await response.json();
    
                // Limpia la tabla
                tablaServicios.innerHTML = "";
    
                // Muestra los resultados
                servicios.forEach(servicio => {
                    const row = `
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 10px;">${servicio.nombre_servicio}</td>
                            <td style="padding: 10px;">${servicio.tipo_procedimiento}</td>
                            <td style="padding: 10px;">${servicio.costo}</td>
                            <td style="padding: 10px;">${servicio.tiempo_estimado}</td>
                            <td style="padding: 10px;">${servicio.tiempo_recuperacion}</td>
                            <td style="padding: 10px;">
                                <button class="btn-editar" style="padding: 5px 10px; background-color: #ffc107; color: white; border: none; border-radius: 4px; cursor: pointer;">Editar</button>
                                <button style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Eliminar</button>
                            </td>
                        </tr>
                    `;
                    tablaServicios.insertAdjacentHTML("beforeend", row);
                });
            } catch (error) {
                console.error("Error al buscar servicios:", error);
            }
        });
    
        // Mostrar el modal para añadir servicio
        btnAgregarServicio.addEventListener("click", () => {
            document.getElementById("modalTitle").textContent = "Añadir Servicio";
            formServicio.reset();
            modal.classList.add("show");
        });
    
        // Función para abrir el modal en modo edición con los datos cargados
        function abrirModalEditar(servicio) {
            document.getElementById("modalTitle").textContent = "Editar Servicio";
            document.getElementById("nombre").value = servicio.nombre_servicio;
            document.getElementById("tipoProcedimiento").value = servicio.tipo_procedimiento;
            document.getElementById("costo").value = servicio.costo;
            document.getElementById("tiempoEstimadoProcedimiento").value = servicio.tiempo_estimado;
            document.getElementById("tiempoEstimadoRecuperacion").value = servicio.tiempo_recuperacion;
            modal.classList.add("show");
        }
    
        // Asignar evento de clic en los botones de editar dentro de cada fila de la tabla
        tablaServicios.addEventListener("click", function (event) {
            if (event.target && event.target.matches(".btn-editar")) {
                const row = event.target.closest("tr");
                const servicio = {
                    nombre_servicio: row.cells[0].textContent.trim(),
                    tipo_procedimiento: row.cells[1].textContent.trim(),
                    costo: row.cells[2].textContent.trim(),
                    tiempo_estimado: row.cells[3].textContent.trim(),
                    tiempo_recuperacion: row.cells[4].textContent.trim(),
                };
                abrirModalEditar(servicio);
            }
        });
    
        // Cerrar el modal
        closeModal.addEventListener("click", () => {
            modal.classList.remove("show");
        });
    
        window.addEventListener("click", (event) => {
            if (event.target === modal) {
                modal.classList.remove("show");
            }
        });
    
        // Guardar o actualizar servicio
        btnGuardar.addEventListener("click", async function () {
            const nombre = document.getElementById("nombre").value.trim();
            const tipoProcedimiento = document.getElementById("tipoProcedimiento").value.trim();
            const costo = document.getElementById("costo").value.trim();
            const tiempoEstimadoProcedimiento = document.getElementById("tiempoEstimadoProcedimiento").value.trim();
            const tiempoEstimadoRecuperacion = document.getElementById("tiempoEstimadoRecuperacion").value.trim();
    
            // Crear objeto con los datos del formulario
            const servicio = { nombre, tipoProcedimiento, costo, tiempoEstimadoProcedimiento, tiempoEstimadoRecuperacion };
    
            try {
                const response = await fetch("/dashboard_jmedico/servicios/guardar", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(servicio)
                });
    
                const result = await response.json();
    
                if (response.ok) {
                    alert(result.mensaje);
                    location.reload(); // Recargar la página para actualizar la tabla
                } else {
                    alert(result.mensaje);
                }
            } catch (error) {
                console.error("Error al guardar el servicio:", error);
                alert("Error al guardar el servicio.");
            }
        });
    });
    </script>
    

<%- include('../_partials/footer') %>
