<%- include('../_partials/header') %>

<div class="dashboard-container">
    <%- include('../_partials/sidebar') %>

    <!-- Contenido Principal -->
    <main id="main-content">
        <header class="dashboard-header">
            <div class="header-content">
                <h1 id="welcome-message" class="welcome-message">Bienvenido a ARAMEDIC</h1>
            </div>
            <div id="user-profile" class="user-profile">
                <!-- El contenido se llenará dinámicamente con JavaScript -->
            </div>
        </header>

        <!-- Lista de Notificaciones -->
        <div id="notifications-panel" class="notifications-panel">
            <h3>Notificaciones</h3>
            <ul class="notifications-list">
                <li class="notification-item">
                    <i class="fas fa-user-clock"></i>
                    <div class="notification-content">
                        <p>Nueva cita programada con Juan Pérez</p>
                        <span class="notification-time">Hace 5 minutos</span>
                    </div>
                </li>
                <li class="notification-item">
                    <i class="fas fa-file-medical-alt"></i>
                    <div class="notification-content">
                        <p>Actualización en la historia clínica de María Gómez</p>
                        <span class="notification-time">Hace 2 horas</span>
                    </div>
                </li>
                <li class="notification-item">
                    <i class="fas fa-calendar-alt"></i>
                    <div class="notification-content">
                        <p>Recordatorio: Conferencia médica mañana</p>
                        <span class="notification-time">Hace 1 día</span>
                    </div>
                </li>
            </ul>
        </div>

        <section id="servicios">
            <h2 class="section-title">Servicios</h2>
            <div class="search-bar">
                <input type="text" id="buscar-servicio" placeholder="Buscar servicio...">
                <button id="agregar-servicio" class="btn-primary">Agregar Servicio</button>
            </div>
            <!-- Formulario para agregar un nuevo servicio -->
            <div id="form-servicio" class="form-servicio">
                <input type="text" id="nombre-servicio" placeholder="Nombre del Servicio">
                <input type="text" id="duracion-servicio" placeholder="Duración (e.g., 30 min)">
                <input type="text" id="precio-servicio" placeholder="Precio (e.g., $50)">
                <button id="guardar-servicio" class="btn-primary">Guardar</button>
            </div>
            <div id="lista-servicios" class="lista-container"></div>
        </section>
    </main>
</div>

<!-- <script src="/dashboard_med/js/main.js"></script> -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById("searchInput");
        const tablaServicios = document.getElementById("tablaServicios");
        const btnAgregarServicio = document.getElementById("btnAgregarServicio");
        const modal = document.getElementById("modalServicio");
        const closeModal = document.querySelector(".close");
        const formServicio = document.getElementById("formServicio");
        const btnGuardar = document.getElementById("btnGuardar");
    
        // Funcionalidad de búsqueda en tiempo real
        searchInput.addEventListener("input", async function () {
            const nombre = searchInput.value.trim();
            
            try {
                const response = await fetch(`/dashboard_jmedico/servicios/buscar?nombre=${encodeURIComponent(nombre)}`);
                const servicios = await response.json();
    
                // Limpia la tabla
                tablaServicios.innerHTML = "";
    
                // Muestra los resultados
                servicios.forEach(servicio => {
                    const row = `
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 10px;">${servicio.nombre_servicio}</td>
                            <td style="padding: 10px;">${servicio.tipo_procedimiento}</td>
                            <td style="padding: 10px;">${servicio.costo}</td>
                            <td style="padding: 10px;">${servicio.tiempo_estimado}</td>
                            <td style="padding: 10px;">${servicio.tiempo_recuperacion}</td>
                            <td style="padding: 10px;">
                                <button class="btn-editar" style="padding: 5px 10px; background-color: #ffc107; color: white; border: none; border-radius: 4px; cursor: pointer;">Editar</button>
                                <button style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Eliminar</button>
                            </td>
                        </tr>
                    `;
                    tablaServicios.insertAdjacentHTML("beforeend", row);
                });
            } catch (error) {
                console.error("Error al buscar servicios:", error);
            }
        });
    
        // Mostrar el modal para añadir servicio
        btnAgregarServicio.addEventListener("click", () => {
            document.getElementById("modalTitle").textContent = "Añadir Servicio";
            formServicio.reset();
            modal.classList.add("show");
        });
    
        // Función para abrir el modal en modo edición con los datos cargados
        function abrirModalEditar(servicio) {
            document.getElementById("modalTitle").textContent = "Editar Servicio";
            document.getElementById("nombre").value = servicio.nombre_servicio;
            document.getElementById("tipoProcedimiento").value = servicio.tipo_procedimiento;
            document.getElementById("costo").value = servicio.costo;
            document.getElementById("tiempoEstimadoProcedimiento").value = servicio.tiempo_estimado;
            document.getElementById("tiempoEstimadoRecuperacion").value = servicio.tiempo_recuperacion;
            modal.classList.add("show");
        }
    
        // Asignar evento de clic en los botones de editar dentro de cada fila de la tabla
        tablaServicios.addEventListener("click", function (event) {
            if (event.target && event.target.matches(".btn-editar")) {
                const row = event.target.closest("tr");
                const servicio = {
                    nombre_servicio: row.cells[0].textContent.trim(),
                    tipo_procedimiento: row.cells[1].textContent.trim(),
                    costo: row.cells[2].textContent.trim(),
                    tiempo_estimado: row.cells[3].textContent.trim(),
                    tiempo_recuperacion: row.cells[4].textContent.trim(),
                };
                abrirModalEditar(servicio);
            }
        });
    
        // Cerrar el modal
        closeModal.addEventListener("click", () => {
            modal.classList.remove("show");
        });
    
        window.addEventListener("click", (event) => {
            if (event.target === modal) {
                modal.classList.remove("show");
            }
        });
    
        // Guardar o actualizar servicio
        btnGuardar.addEventListener("click", async function () {
            const nombre = document.getElementById("nombre").value.trim();
            const tipoProcedimiento = document.getElementById("tipoProcedimiento").value.trim();
            const costo = document.getElementById("costo").value.trim();
            const tiempoEstimadoProcedimiento = document.getElementById("tiempoEstimadoProcedimiento").value.trim();
            const tiempoEstimadoRecuperacion = document.getElementById("tiempoEstimadoRecuperacion").value.trim();
    
            // Crear objeto con los datos del formulario
            const servicio = { nombre, tipoProcedimiento, costo, tiempoEstimadoProcedimiento, tiempoEstimadoRecuperacion };
    
            try {
                const response = await fetch("/dashboard_jmedico/servicios/guardar", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(servicio)
                });
    
                const result = await response.json();
    
                if (response.ok) {
                    alert(result.mensaje);
                    location.reload(); // Recargar la página para actualizar la tabla
                } else {
                    alert(result.mensaje);
                }
            } catch (error) {
                console.error("Error al guardar el servicio:", error);
                alert("Error al guardar el servicio.");
            }
        });
    });
    </script>
    

    const formData = {
        username: 'jose'
    }

    axios.post('http://localhost:3000/dashboard_jmedico/test', formData , config)
        .then(response => {
            console.log(response.data)
        });

    // Mostrar servicios por defecto
    mostrarServicios();

    // Evento para guardar un nuevo servicio
    document.getElementById("guardar-servicio").addEventListener("click", () => {
        const nombreServicio = document.getElementById("nombre-servicio").value.trim();
        const duracionServicio = document.getElementById("duracion-servicio").value.trim();
        const precioServicio = document.getElementById("precio-servicio").value.trim();

        if (nombreServicio && duracionServicio && precioServicio) {
            // Si todos los campos están llenos, agregar el servicio
            agregarServicio(nombreServicio, duracionServicio, precioServicio);
            limpiarFormulario();
        } else {
            // Si algún campo está vacío, mostrar una alerta
            alert("Por favor, complete todos los campos.");
        }
    });

    function agregarServicio(nombre, duracion, precio) {
        const listaServicios = document.getElementById("lista-servicios");
        const servicioCard = document.createElement("div");
        servicioCard.className = "servicio-card";
        servicioCard.innerHTML = `
            <h3>${nombre}</h3>
            <p><strong>Duración:</strong> ${duracion}</p>
            <p><strong>Precio:</strong> ${precio}</p>
            <button class="btn-primary" onclick="editarServicio()">Editar</button>
        `;
        listaServicios.appendChild(servicioCard);
    }

    function limpiarFormulario() {
        document.getElementById("nombre-servicio").value = "";
        document.getElementById("duracion-servicio").value = "";
        document.getElementById("precio-servicio").value = "";
    }

    function mostrarServicios() {
        const listaServicios = document.getElementById("lista-servicios");
        listaServicios.innerHTML = `
            <div class="servicio-card">
                <h3>Consulta General</h3>
                <p><strong>Duración:</strong> 30 min</p>
                <p><strong>Precio:</strong> $50</p>
                <button class="btn-primary" onclick="editarServicio()">Editar</button>
            </div>
            <div class="servicio-card">
                <h3>Examen de Laboratorio</h3>
                <p><strong>Duración:</strong> 1 hora</p>
                <p><strong>Precio:</strong> $100</p>
                <button class="btn-primary" onclick="editarServicio()">Editar</button>
            </div>
        `;
    }

});
</script>
<%- include('../_partials/footer') %>
